<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <base target="_blank"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> [#0004] Complete takeover of any Google Fast Pair headphones vendor settings &amp; secrets | feed </title> <meta name="description" content=" xdavidhu&#39;s bug bounty disclosures. "> <meta name="keywords" content=""> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="xdavidhu"> <meta name="twitter:title" content="Complete takeover of any Google Fast Pair headphones vendor settings & secrets"> <meta name="twitter:description" content="xdavidhu's bug bounty disclosures."> <meta name="twitter:image:src" content="http://192.168.56.106:9885/asd/assets/img/cover.png"> <!-- Social: Open Graph --> <meta name="title" property="og:title" content="Complete takeover of any Google Fast Pair headphones vendor settings & secrets"> <meta name="description" property="og:description" content="xdavidhu's bug bounty disclosures."> <meta name="image" property="og:image" content="http://192.168.56.106:9885/asd/assets/img/cover.png"> <meta name="author" content="David Schütz"> <!-- Canonical link tag --> <link rel="canonical" href="http://192.168.56.106:9885/asd/bugs/0004"> <link rel="alternate" type="application/rss+xml" title="feed" href="http://192.168.56.106:9885/asd/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="http://192.168.56.106:9885/asd/assets/css/main.css"> </head> <body> <main class="wrapper"> <header class="site-header"> <nav> <div class="container nav-container"> <h1 class="logo"><a href="http://192.168.56.106:9885/asd/" target="_self">feed<span></span></a></h1> <ul class="navbar"> <li><a href="https://bugs.xdavidhu.me/" target="_self">bugs.xdavidhu.me</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"> <span>#0004</span><br/> <span>Vendor: Google</span><br/> <span>Status: fixed</span><br/> <span>Reported: Feb 15, 2021</span><br/> <span>Disclosed: </span><time datetime="2021-05-16T00:00:00+00:00" itemprop="datePublished">May 16, 2021</time> (90 days) </p> <h1 class="post-title" itemprop="name headline">Complete takeover of any Google Fast Pair headphones vendor settings & secrets</h1> </header> <div class="post-content" itemprop="articleBody"> <p><strong>Summary:</strong></p> <p>I think this is pretty bad. Using this issue, a malicious attacker could have <strong>full CRUD (Create, Read Update, Delete) access to all Google <a href="https://developers.google.com/nearby/fast-pair/spec">Fast Pair devices</a></strong>. The attacker could even steal the secret Anti-Spoofing Private Key for any device, which would allow the attacker to <strong>spoof the given device’s identity</strong> and/or to <strong>perform MITM attacks against any new Fast Pair Bluetooth connection established with that device</strong>.</p> <p><strong>Core issue:</strong></p> <p>The API <code class="language-plaintext highlighter-rouge">nearbydevices-pa.googleapis.com</code> <strong>doesn’t seem to perform any kind of access control</strong>. Thus, a normal authenticated user can access/modify/delete any resource, including resources the user doesn’t own. This allows full CRUD access to all Fast Pair devices.</p> <p><strong>Steps to reproduce:</strong></p> <ol> <li>Create 2 users: <code class="language-plaintext highlighter-rouge">Attacker</code> and <code class="language-plaintext highlighter-rouge">Victim</code></li> <li>With both users, visit <code class="language-plaintext highlighter-rouge">https://developers.google.com/nearby/devices/</code>, log in, and create one GCP project when prompted</li> <li>With both users, in new tabs, go to <code class="language-plaintext highlighter-rouge">https://console.cloud.google.com/</code>, and note both new project’s <code class="language-plaintext highlighter-rouge">Project number</code>s</li> <li>[<code class="language-plaintext highlighter-rouge">Victim</code>] Go to <code class="language-plaintext highlighter-rouge">Add Device</code>, and create a new device. (Choose <code class="language-plaintext highlighter-rouge">Fast Pair</code> -&gt; <code class="language-plaintext highlighter-rouge">Headphones</code> for the least required fields &amp; You must upload an 512x512 image)</li> <li>[<code class="language-plaintext highlighter-rouge">Attacker</code>] Start proxying the traffic with Burp</li> <li>[<code class="language-plaintext highlighter-rouge">Attacker</code>] In Burp, go to <code class="language-plaintext highlighter-rouge">Proxy</code> -&gt; <code class="language-plaintext highlighter-rouge">Options</code> -&gt; <code class="language-plaintext highlighter-rouge">Match and Replace</code> and click <code class="language-plaintext highlighter-rouge">Add</code></li> <li>[<code class="language-plaintext highlighter-rouge">Attacker</code>] Set the type to <code class="language-plaintext highlighter-rouge">Request body</code>, set <code class="language-plaintext highlighter-rouge">Match</code> to <code class="language-plaintext highlighter-rouge">Attacker</code>’s <code class="language-plaintext highlighter-rouge">Project number</code>, set <code class="language-plaintext highlighter-rouge">Replace</code> to <code class="language-plaintext highlighter-rouge">Victim</code>’s <code class="language-plaintext highlighter-rouge">Project number</code> from <code class="language-plaintext highlighter-rouge">Step 3</code>, and click <code class="language-plaintext highlighter-rouge">OK</code></li> <li>[<code class="language-plaintext highlighter-rouge">Attacker</code>] Click on the <code class="language-plaintext highlighter-rouge">Devices</code> button, and see a list of <code class="language-plaintext highlighter-rouge">Victim's</code> devices</li> <li>[<code class="language-plaintext highlighter-rouge">Attacker</code>] Click on the device created in <code class="language-plaintext highlighter-rouge">Step 4</code> and see that you can access its secret Anti-Spoofing Private Key, add a new firmware revision, edit the device, view analytics, delete the device, and more. Basically attacker now has full access to all of <code class="language-plaintext highlighter-rouge">Victim</code>’s resources, just by changing the project number.</li> </ol> <p><strong>A real-world attack:</strong></p> <p>For the above POC, an attacker needs to know the project ID of the targeted device.<br /> Thats not bad, but we can do better.</p> <p>Here is a theoretical real world MITM attack against all second generation Google Pixel Buds devices:</p> <ol> <li>Attacker would like to MITM Bluetooth connections between Pixel Buds devices and victims. For this, Attacker would need to obtain the Pixel Buds’s Anti-Spoofing Private Key. This key is (hopefully) <a href="https://developers.google.com/nearby/fast-pair/spec#antispoofing">stored in the secure enclave</a> of every manufactured Pixel Buds device. So it is hidden from the Attacker.</li> <li>Attacker buys a Pixel Buds, and proxies her phone’s traffic while pairing the device.</li> <li>From the proxy logs, attacker finds the gRPC request her phone made to <code class="language-plaintext highlighter-rouge">nearbydevices-pa.googleapis.com/location.nearby.v1.NearbyDevicesService/GetObservedDevice</code>, and extract’s the Pixel Buds’s <code class="language-plaintext highlighter-rouge">Model ID</code> and <code class="language-plaintext highlighter-rouge">Project Number</code> from the response protobuf</li> <li>Attacker now has all of the necessary information to access the Pixel Buds’s Anti-Spoofing Private Key</li> <li>Attacker sends this request, which returns the Anti-Spoofing Private Key:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /v1/projects/[pixel's_project_number]/devices/[prixel's_model_id_in_decimal]?key=AIzaSyBbXGPRxbh6-U8pujg5-lABDGuThIjtn38 HTTP/1.1
Host: nearbydevices-pa.googleapis.com
Authorization: Bearer [attacker's_nearby_dashboard_access_token]
</code></pre></div></div> <ol start="6"> <li>Attacker now can <a href="https://developers.google.com/nearby/fast-pair/spec#ProcedureExamples">MITM any new Fast Pair Bluetooth connection</a> between any second generation Pixel Buds and any victitm.</li> </ol> <p><em>I performed this attack until <code class="language-plaintext highlighter-rouge">Step 4.</code> to confirm that the gRPC response leaks the <code class="language-plaintext highlighter-rouge">Project Number</code>. By this, I found that the second generation Pixel Buds’s has a <code class="language-plaintext highlighter-rouge">Model ID</code> of <code class="language-plaintext highlighter-rouge">9616317</code> (<code class="language-plaintext highlighter-rouge">0x92BBBD</code> in hex), and a <code class="language-plaintext highlighter-rouge">Project Number</code> of <code class="language-plaintext highlighter-rouge">88849360756</code>.</em></p> <p>Or, you know, if an attacker want’s to be just pure destructive, she could just <strong>delete the Pixel Buds device</strong>, so Fast Pair Seekers don’t recognize it anymore. Or, she could <strong>change the Pixel Buds’s name/image to something inappropriate</strong>. Or, do anything, basically.</p> <p><strong>[!!] Because of this, if previous malicious access to this API can’t be confidently refuted, consider ALL already-generated Anti-Spoofing Private Keys on the Fast Pair platform COMPROMISED.</strong></p> <p><strong>Extras / The horror-story of decoding the protobuf:</strong></p> <ul> <li>I wanted to make sure that the <code class="language-plaintext highlighter-rouge">GetObservedDevice</code> gRPC method returns the device’s <code class="language-plaintext highlighter-rouge">Project Number</code>, so I wanted to decode the binary protobuf. I spent basically a day trying to decode that protobuf without success. Every tool I tried (<code class="language-plaintext highlighter-rouge">protoc</code>, <code class="language-plaintext highlighter-rouge">blackboxprotobuf</code>, …) failed to decode the response, not sure why. I found out how gRPC prefixed the proto payload, but even after removing the prefix, every tool failed. I even tried programmatically cutting out bytes from the beginning/end, without success.</li> <li>I was forced to use the protobuf response, since the same REST endpoint, <code class="language-plaintext highlighter-rouge">/v1/device/[device-id]</code>, for some reason only returned the ID you gave to it, without doing anything.</li> <li>After quite a few hours and almost loosing all hope, I added <code class="language-plaintext highlighter-rouge">$outputDefaults=1</code> to the REST endpoint, and it returned every field, but of course, they were all empty.</li> <li>I knew that if I change the <code class="language-plaintext highlighter-rouge">Content-Type</code> to <code class="language-plaintext highlighter-rouge">application/json+protobuf</code>, the response will include the field IDs of the protobuf. I used this, and <code class="language-plaintext highlighter-rouge">$outputDefaults=1</code> to correlate the <code class="language-plaintext highlighter-rouge">id</code> and <code class="language-plaintext highlighter-rouge">projectNumber</code> to the protobuf field ID <code class="language-plaintext highlighter-rouge">1</code> and <code class="language-plaintext highlighter-rouge">2</code>, because the ordering of the fields looked the same in both cases.</li> <li>After checking where the strings were the binary protobuf, I concluded that it’s thankfully in the same exact order as in the REST responses. So I only need to decode the first 2 fields in the protobuf, and simply ignore everything else.</li> <li>Since all tools failed on me, I took the last road. I had to <a href="https://developers.google.com/protocol-buffers/docs/encoding#structure">hand-decode</a> the protobuf. It was <em>very epic</em>:</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0a -&gt; 00001010 -&gt; 00001 010 -&gt; length-delimited:2 ID:1
lenght:
ca 07 -&gt; 11001010 00000111
      -&gt; 10010100000111
      -&gt; len = 9479 ?! (I just noticed that this is incorrect. I din't swap the bytes)

08 -&gt; 1000 -&gt; varint:0 ID:1 ("id")
bd f7 ca 04 -&gt; 10111101 11110111 11001010 00000100
            -&gt;  0111101  1110111  1001010  0000100
            -&gt; 0000100 1001010 1110111 0111101
            -&gt; 0000100100101011101110111101
            -&gt; device ID: 9616317 0x92BBBD (pixel buds) omg, this is correct!!

10 -&gt; 10000 -&gt; varint:0 ID:2 ("projectNumber" !!)
f4 ce d6 fe ca 02 -&gt; 11110100 11001110 11010110 11111110 11001010 00000010
                  -&gt;  1110100  1001110  1010110  1111110  1001010  0000010
                  -&gt; 0000010 1001010 1111110 1010110 1001110 1110100
                  -&gt; 000001010010101111110101011010011101110100
                  -&gt; project ID: 88849360756
</code></pre></div></div> <p><strong>[Disclosure Warning]:</strong></p> <p><strong>This issue is subject to a 90 day disclosure deadline.</strong> On <code class="language-plaintext highlighter-rouge">2021-05-16</code> this issue will be publicly disclosed. If you would like to redact additional information or if for some reason the issue can’t be fixed until the deadline, let me know in a comment.</p> <p>Thank you!</p> <hr /> <h3 id="comments">Comments:</h3> <p><strong>Vendor - 2021-02-15 17:21</strong></p> <p><em>NOTE: This e-mail has been generated automatically.</em></p> <p>Thanks for your report.</p> <p>This email confirms we’ve received your message. We’ll investigate and get back to you once we’ve got an update. In the meantime, you might want to take a look at the <a href="https://sites.google.com/site/bughunteruniversity/behind-the-scenes/faq">list of frequently asked questions about Google VRP</a>.</p> <p>If you are reporting a security vulnerability and wish to appear in Google Security Hall of Fame, please <a href="https://bughunter.withgoogle.com/new_profile">create a profile</a>.</p> <p>You appear automatically in our Honorable Mentions if we decide to file a security vulnerability based on your report, and you will also show up in our Hall of Fame if we issue a reward.</p> <p><strong>Note that if you did not report a vulnerability, or a technical security problem in one of our products, we won’t be able to act on your report. This channel is not the right one if you wish to resolve a problem with your account, report non-security bugs, or suggest a new feature in our product.</strong></p> <p>Cheers, <br /> Google Security Bot</p> <p><a href="https://twitter.com/googlevrp">Follow us</a> on Twitter!</p> <hr /> <p><strong>Vendor - 2021-02-16 22:19</strong></p> <p><em>NOTE: This e-mail has been generated automatically.</em></p> <p>Hey,</p> <p>Just letting you know that your report was <strong>triaged</strong> and we’re currently looking into it.</p> <p>You should receive a response in a couple of days, but it might take up to a week if we’re particularly busy. In the meantime, you might want to take a look at <a href="https://sites.google.com/site/bughunteruniversity/behind-the-scenes/faq">the list of frequently asked questions about Google VRP</a>.</p> <p>Thanks, <br /> Google Security Bot</p> <hr /> <p><strong>Vendor - 2021-02-24 13:45</strong></p> <p>Hi,</p> <p>🎉 <strong>Nice catch!</strong> I’ve filed a bug based on your report.</p> <p>The panel will evaluate it at the next VRP panel meeting and we’ll update you once we’ve got more information. All you need to do now is wait. If you don’t hear back from us in 2-3 weeks or have additional information about the vulnerability, let us know!</p> <p>Regards, <br /> [redacted], Google Security Team</p> <hr /> <p><strong>Vendor - 2021-03-04 21:20</strong></p> <p>** NOTE: This is an automatically generated email **</p> <p>Hello,</p> <p>Thank you for reporting this bug. As part of Google’s Vulnerability Reward Program, the panel has decided to issue a reward of $5000.00.</p> <p>Important: if you aren’t registered with Google as a supplier, p2p-vrp@google.com will reach out to you. If you have registered in the past, no need to do it again - sit back and relax, and we will process the payment soon.</p> <p>If you have any payment related requests, please direct them to p2p-vrp@google.com. Please remember to include the subject of this email and the email address that the report was sent from. Regards,</p> <p>Google Security Bot</p> <p>If you’d like your name added to our Hall of Fame:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://bughunter.withgoogle.com/
</code></pre></div></div> <p>Just create a profile here: https://bughunter.withgoogle.com/new_profile</p> <p>In addition, we encourage you to signup for our Vulnerability Research Grants program, where we issue monetary payments to VRP researchers, even when no vulnerabilities are found. To read more about the program visit: https://www.google.com/about/appsecurity/research-grants/</p> <p>– How did we do? Please fill out a short anonymous survey (https://goo.gl/IR3KRH).</p> <hr /> <p><strong>Me - 2021-04-26 17:51</strong></p> <p>Hi,</p> <p>This bug will be publicly disclosed in 20 days, on <code class="language-plaintext highlighter-rouge">2021-05-16</code>.</p> <p>Can you please confirm that the issue has been fixed and that no <code class="language-plaintext highlighter-rouge">Anti-Spoofing Private Key</code> was compromised using this attack?</p> <p>Thank you, <br /> David</p> <hr /> <p><strong>Vendor - 2021-04-30 20:24</strong></p> <p>hi!</p> <p>the team is currently working on the fix, there’s two steps for the fix, and the first step is almost done, but the second one has been taking some time to complete.</p> <hr /> <p><strong>Me - 2021-05-06 12:44</strong></p> <p>Hi,</p> <p>The 90 day deadline will expire in 10 days, on <code class="language-plaintext highlighter-rouge">2021-05-16</code>. Will a fix be rolled out by then?</p> <p>If a fix is scheduled to fully roll out in the next 14 days after the deadline, let me know, and the disclosure will be delayed by 2 weeks, as described in Google Project Zero’s “Grace period”.</p> <p>Can you please confirm that (after the issue has been fixed) no <code class="language-plaintext highlighter-rouge">Anti-Spoofing Private Key</code> was compromised using this attack? <br /> Since as far as I know, once compromised, these keys can not be changed on the devices already manufactured. Users should be aware if their model’s key is compromised, thus allowing MITM attacks.</p> <p>Thank you, <br /> David</p> <hr /> <p><strong>Vendor - 2021-05-07 22:26</strong></p> <p>Thanks David!</p> <p>We have been making several changes, so you probably wont be able to exploit this anymore, but we are still working on making more changes, and the last of those changes probably won’t land until June 16.</p> <p>The keys are updatable through firmware updates, but some devices dont get firmware updates :). That said, those that do, also probably store the key in the clear anyway.</p> <p>Maybe it’s worth noting that the keys we are talking about here are on the devices that the customers buy (so you can get them from there too in most cases by just dumping the firmware), so they may allow for impersonation of an “original device”, but otherwise shouldn’t have significant security consequences. Also, fastpair doesn’t allow for most bluetooth profiles, so besides being a music sink and a few other things, it should not be too serious for users. All devices require user confirmation/etc.</p> <p>I suggest you look at the difference with Fastpair with a key you own, and a key you take from another device (if you didn’t keep any keys from when the bug was working, maybe find the firmware of some device with fastpair and extract the key from there).</p> <hr /> <p><strong>Me - 2021-05-16 23:38</strong></p> <p>Hi,</p> <p>Thank you for the response.</p> <p>So, my conclusion is that this means that users <em>should not</em> rely on any security protection this “secret” <code class="language-plaintext highlighter-rouge">Anti-Spoofing Private Key</code> provides, especially they <em>should not</em> rely on MITM protection, and consider all their Bluetooth traffic sniffable by a malicious party.</p> <p>Thats a bit sad, because it would be a very nice feature of Fast Pair, but I guess it would be hard (or even impossible) to push out a secret key in consumer devices in a way that the owners can’t ever access it.</p> <p>(Hopefully, at least the Pixel Buds follows the spec, and uses a Secure Element to store the key.. 😬)</p> <p>Thank you, <br /> David</p> </div> </article> </main> </body> </html>
